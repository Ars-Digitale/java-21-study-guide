### Stream Chaining Rules and Common Errors

The previous example illustrates stream chaining, a core concept in `java.io` based on the decorator pattern. Each stream wraps another stream, adding functionality while preserving a strict type hierarchy.

@@H4@@1. Fundamental Chaining Rule@@H4_END@@

A stream can only wrap another stream of a compatible abstraction level.

- Byte streams can only wrap byte streams
- Character streams can only wrap character streams
- High-level streams require an underlying low-level stream

> **Note:** You cannot arbitrarily mix `InputStream` with `Reader` or `OutputStream` with `Writer`.

@@H4@@2. Byte vs Character Stream Incompatibility@@H4_END@@

A very common error is attempting to wrap a byte stream directly with a character-based class (or vice versa).

### Invalid Chaining (Compile-Time Error)

```java
BufferedReader reader =
new BufferedReader(new FileInputStream("text.txt"));
```

> **Note:** This fails because `BufferedReader` expects a `Reader`, not an `InputStream`.

@@H4@@3. Bridging Byte Streams to Character Streams@@H4_END@@

To convert between byte-based and character-based streams, Java provides bridge classes.

- `InputStreamReader` converts bytes → characters
- `OutputStreamWriter` converts characters → bytes

### Correct Conversion Pattern

```java
BufferedReader reader =
new BufferedReader(
new InputStreamReader(
new FileInputStream("text.txt")));
```

> **Note:** The bridge handles character decoding using a charset (default or explicit).

@@H4@@4. Ordering Rules in Stream Chains@@H4_END@@

The order of wrapping is not arbitrary and is often tested in certification exams.

- Low-level stream must be innermost
- Bridges (if needed) come next
- Buffered or processing streams come last

### Correct Logical Order

```text
FileInputStream → InputStreamReader → BufferedReader
```

@@H4@@5. Resource Management Rule@@H4_END@@

Closing the outermost stream automatically closes all wrapped streams.

> **Note:** This is why try-with-resources should reference only the highest-level stream.

@@H4@@6. Certification Pitfalls@@H4_END@@

- Trying to buffer a stream of the wrong type
- Forgetting the bridge between byte and char streams
- Assuming `Reader` works with binary data
- Using default charset unintentionally

> **Note:** If a question mentions text, encoding, or characters, a `Reader` is required somewhere in the chain.